<!doctype html>

<html lang="en">
<head>
	<meta charset="utf-8">

	<title>Waiting Children</title>
	<meta name="description" content="BCI Children Demo">
	<meta name="author" content="BCI">
	<link href="https://fonts.googleapis.com/css?family=Reem+Kufi|Roboto|Roboto+Condensed" rel="stylesheet">

	<style>
		body {
			padding: 20px;
			background-color: #FFFFFF;
			font-family: 'Roboto', sans-serif;
			font-size: 14pt;

		}

		.child-row {
			margin-bottom: 15px;
			height: 410px;
		}

		.child {
			width: 340px;
			height: 410px;
			background-color: white;
			float: left;
			margin-right: 15px;
		}

		.child-image {
			width: 340px;
			height: 296px;
		}

		.child-body {
			padding: 3px;
			font-family: 'Roboto', sans-serif;
            margin-left: 12px;
            line-height: 3pt;
		}

		.moreinfobutton {
			width: 110px;
			height: 30px;
			background-color: #4CAF50;
			border: none;
			color: white;
			padding: 2px 2px;
			text-align: center;
			font-size: 16px;
            font-weight: bold;
			cursor: pointer;
		}

		.moreinfobutton:hover {
			background-color: #316100;
		}

		#show-more {
			width: 200px;
			height: 56px;
			background-color: #0A0C21;
			margin-top: 10px;
			display: none;
			font-size: 20pt;
            font-weight: bold;
            color: white;
		}

		#show-more:hover {
			background-color: #e6eded;
		}

	</style>
</head>

<body>
	<!--Start of Header-->
	<section style="font-family: Arial; color: #ff0000; background-color: black; height: 32pt; padding: 3pt;"><img src="http://blessingthechildren.com/assets/images/new-logo-all-white-110x53.png" alt="logo" width="90" height="43" /></section>	
	<!--End of Header-->

	<!--Start of body-->
	<h1><span style="color: #F06000; font-family: 'Reem Kufi', sans-serif;">Blessing the Children International</span></h1>
	<div id="child-list" style="font-family: 'Roboto', sans-serif;font-size: 14pt;">
		<p> Please join us in caring for the children who have no one. <br />
			All it takes is $1 a day to make a real difference. <br />
			We invite you to read their stories and learn more about these precious children. </p>
		</div>
	<!--End of body-->

	<input type="button" value="Show More" id="show-more" />

	<!-- Scripts -->
	<script
	  src="https://code.jquery.com/jquery-3.3.1.min.js"
	  integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
	  crossorigin="anonymous"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/4.0.12/handlebars.min.js"></script>

	<script id="child-template" type="text/x-handlebars-template">
		<div class="child">
			<img src="{{WebPageUrl}}" class="child-image" />

			<div class="child-body">
                <h2 style="font-family: 'Roboto Condensed', sans-serif;">{{Title}}</h2>
                
				<p>I am <b> {{Age}} </b> years old <span style="float:right;"><button class="moreinfobutton">Child Info...</button></span></p>
				<p>I am a <b> {{GenderString}} </b> </p>
				<p>I've been waiting <b> {{WaitingString}}</b>
				<span style="display:none">'</span>
			</div>
		</div>
	</script>

	<script type="text/javascript">

		$(function() {
			$.ajax({
				type: 'GET',
				url: 'https://bci-sharepointcall.azurewebsites.net/api/children',
				dataType: 'jsonp',
				jsonpCallback: 'receiveChildrenData'
			});
		});

		function receiveChildrenData(children) {
			var childTemplateSource = document.getElementById("child-template").innerHTML;
			var template = Handlebars.compile(childTemplateSource);
			var ageLimit = new Date();
			ageLimit.setFullYear( ageLimit.getFullYear() - 13 );

			children = children.filter(function(c) { return c.ActiveForSponsorship && c.SponsorshipNeeded > 0 && new Date(c.Birthday) > ageLimit; })
				.sort(firstBy("Priority", -1).thenBy("SponsorshipNeeded", -1));
			console.log(children);
			window.nextIndex = 0;
            
			appendNewRow(children, template);
			$('#show-more').show();

			$('#show-more').click(function() {
				appendNewRow(children, template);
			});
		}

		function appendNewRow(children, template) {
			var htmlArray = [];

			for (var i = 0; i < 3; i++) {
				var child = calcData(children[nextIndex]);
				htmlArray.push(template(child));
				nextIndex++;
			}

			var newDiv = document.createElement("div");
			newDiv.className = 'child-row';
			newDiv.innerHTML = htmlArray.join('');

			document.getElementById('child-list').appendChild(newDiv);
		}

		function calcData(child) {
			child.Age = calculateAge(child.Birthday);
			child.GenderString = child.Gender == 'Female' ? 'girl' : 'boy';
			child.WaitingString = calculateWaiting(child.StartDate);
			return child;
		}

		function calculateAge(birthday) {
			var birthDate = new Date(birthday);
		    var ageDifMs = Date.now() - birthDate.getTime();
		    var ageDate = new Date(ageDifMs); // miliseconds from epoch
		    return Math.abs(ageDate.getUTCFullYear() - 1970);
		}

		function calculateWaiting(sinceDate) {
			var oneDay = 24*60*60*1000; // hours*minutes*seconds*milliseconds
			var firstDate = new Date(sinceDate);
			var secondDate = Date.now();

			var days = Math.round(Math.abs((firstDate.getTime() - secondDate)/(oneDay)));
			if (days >= 365)
				return 'more than a year';
			return days + ' days';
		}


		// thenBy.js
		/*** Copyright 2013 Teun Duynstee Licensed under the Apache License, Version 2.0 ***/
		!function(n,t){"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?module.exports=t():n.firstBy=t()}(this,function(){var n=function(){function n(n){return n}function t(n){return"string"==typeof n?n.toLowerCase():n}function r(r,e){if(e="number"==typeof e?{direction:e}:e||{},"function"!=typeof r){var i=r;r=function(n){return n[i]?n[i]:""}}if(1===r.length){var o=r,f=e.ignoreCase?t:n,u=e.cmp||function(n,t){return n<t?-1:n>t?1:0};r=function(n,t){return u(f(o(n)),f(o(t)))}}return e.direction===-1?function(n,t){return-r(n,t)}:r}function e(n,t){var i="function"==typeof this&&!this.firstBy&&this,o=r(n,t),f=i?function(n,t){return i(n,t)||o(n,t)}:o;return f.thenBy=e,f}return e.firstBy=e,e}();return n});
	</script>
</body>
</html>
